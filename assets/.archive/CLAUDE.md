# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**noseeum** is a modular offensive security framework for Unicode-based exploitation attacks. It implements techniques including Trojan Source (Bidi), homoglyph substitution, invisible character encoding, and language-specific Unicode vulnerabilities to hide malicious code in plain sight.

## Essential Build Commands

### Setup and Installation
```bash
# Generate required data files (MUST run before installation)
python3 create_registry.py      # Creates homoglyph_registry.json
python3 create_nfkc_map.py      # Creates nfkc_map.json

# Install the package globally
pip install .
# or
make install

# Uninstall
make uninstall

# Clean build artifacts
make clean
```

### Testing
```bash
# Install with dev dependencies
pip install -e ".[dev]"

# Run test suite
pytest tests/

# Run specific test file
pytest tests/test_scanner.py
```

### Usage
```bash
# View all commands
noseeum --help

# View attack commands
noseeum attack --help

# Scan for Unicode vulnerabilities
noseeum detect --file /path/to/file.js

# View framework info
noseeum info
noseeum techniques
noseeum vulnerabilities --target-language python
```

## Architecture

### Core Module Structure

The framework uses a **plugin-based architecture** with the following key components:

1. **`noseeum/core/engine.py`**: Central `ObfuscationEngine` that manages all attack modules
   - Defines `ObfuscationTechnique` enum (BIDI, HOMOGLYPH, INVISIBLE, etc.)
   - Defines `LanguageSupport` enum (PYTHON, JAVASCRIPT, JAVA, GO, KOTLIN, SWIFT, RUST, C, CPP)
   - All attack modules implement the `ObfuscationModule` abstract base class
   - Modules are registered at import time in `noseeum/core/__init__.py`

2. **`noseeum/core/grammar_db.py`**: Language grammar database
   - Stores language-specific Unicode handling rules and vulnerabilities
   - Provides vulnerability lookup for target languages

3. **`noseeum/core/language_dispatcher.py`**: Routes requests to language-specific modules
   - Handles language detection and module selection
   - Registered as `ObfuscationTechnique.LANGUAGE_SPECIFIC`

4. **`noseeum/attacks/`**: Attack vector implementations
   - Each module is self-contained and exposes both a CLI command and a programmatic module
   - Basic attacks: `bidi.py`, `homoglyph.py`, `invisible.py`, `language.py`
   - Advanced attacks: `normalization.py`, `unassigned_planes.py`, `payload_injection.py`, `hangul_encoding.py`
   - Language-specific: `go_attack.py`, `kotlin_attack.py`, `javascript_attack.py`, `swift_attack.py`

5. **`noseeum/detector/scanner.py`**: Vulnerability detection
   - Scans source code for Unicode smuggling attacks
   - Detects bidirectional control characters, zero-width characters, and homoglyphs
   - Uses `config.json` for detector configuration

6. **`noseeum/cli.py`**: CLI entry point
   - Uses `click` for command-line interface
   - Three command groups: `attack`, `advanced`, `language_specific`
   - Top-level commands: `detect`, `info`, `techniques`, `vulnerabilities`

### Data Files

The framework requires two generated JSON files for operation:

- **`homoglyph_registry.json`**: Maps visually similar Unicode characters (generated by `create_registry.py`)
- **`nfkc_map.json`**: Unicode normalization mappings (generated by `create_nfkc_map.py`)
- **`config.json`**: Runtime configuration including detector settings

These files must be generated before installation and are packaged with the distribution.

### Module Registration Pattern

New attack modules are registered in `noseeum/core/__init__.py`:

```python
# Import the module
from noseeum.attacks.new_attack import new_attack_module

# Register with engine
engine.register_module(ObfuscationTechnique.NEW_ATTACK, new_attack_module)

# For language-specific modules, also register with dispatcher
language_dispatcher_module.register_language_module(LanguageSupport.LANG, module)
```

Each attack module must:
1. Implement the `ObfuscationModule` interface with `get_name()`, `get_description()`, `get_supported_languages()`, and `obfuscate()`
2. Provide a `@click.command()` function for CLI access
3. Export a module instance for programmatic registration

### Utility Modules

- **`noseeum/utils/error_handlers.py`**: Shared error handling and file I/O utilities
  - `validate_line_number()`: Validates line numbers for file injection
  - `handle_file_error()`: Centralized file error handling
  - `read_file_with_encoding()`: Robust file reading with encoding detection

### Supporting Core Modules

- **`stealth_engine.py`**: Stealth and evasion tactics
- **`evasion_library.py`**: Library of evasion techniques
- **`linguistic_generator.py`**: Language-specific code generation
- **`test_validator.py`**: Output validation for generated payloads
- **`yara_generator.py`**: YARA rule generation for detection
- **`integration.py`**: Module integration and orchestration

## Key Design Principles

1. **Modularity**: Each attack vector is self-contained and can be developed independently
2. **Language-agnostic core**: The engine supports multiple target languages through grammar definitions
3. **CLI-first design**: All functionality is exposed through the `noseeum` command
4. **Defensive awareness**: Includes detection capabilities (`noseeum detect`) to identify vulnerabilities
5. **Data-driven**: Attack behaviors are configured through JSON data files

## Working with Attacks

When analyzing or documenting attack modules:
- Each attack has a specific Unicode exploitation technique (see README.md for full list)
- Attacks often manipulate bidirectional text, zero-width characters, or homoglyphs
- The `sanitize_payload()` pattern is used to ensure payloads are valid for target languages
- File injection typically uses line number-based insertion with validation

## Configuration

Global configuration is stored in `config.json` in the repository root:
- `registry_path`: Path to homoglyph registry
- `nfkc_map_path`: Path to NFKC normalization map
- `default_encoding`: File encoding (UTF-8)
- `detector_confusable_scripts`: Unicode scripts to check for homoglyph attacks

## Python Version Compatibility

The project targets Python 3.8+ with backward compatibility considerations:
- Uses `importlib-resources` for Python <3.9
- Avoids Python 3.9+ specific type annotations
- Test with `pytest` (included in dev dependencies)
