"""Vulnerability Cartographer - Maps attack surfaces."""

import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../..')))

from typing import Dict, List, Any, Optional
from agents.base.agent import BaseAgent, AgentCapability
from agents.base.tools import AgentToolkit
from agents.base.memory import AgentMemory


class VulnerabilityCartographer(BaseAgent):
    """Maps and visualizes attack surfaces across languages."""

    def __init__(self, config: Dict[str, Any]):
        super().__init__(
            agent_id="vulnerability_cartographer",
            name="Vulnerability Cartographer",
            description="Maps attack surfaces",
            capabilities=[AgentCapability.ANALYSIS],
            config=config
        )
        self.toolkit = AgentToolkit()
        self.memory = AgentMemory(self.agent_id)

    def get_tools(self) -> List[Dict[str, Any]]:
        return self.toolkit.get_noseeum_tools()

    def run(self, task: str, context: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        self.start()
        session_id = self.memory.start_session(task)

        try:
            # Map vulnerabilities across languages
            vuln_map = self._map_vulnerabilities()

            # Generate attack tree
            attack_tree = self._generate_attack_tree(vuln_map)

            # Create visualization
            viz_path = self._create_visualization(attack_tree)

            result = {"vulnerability_map": vuln_map, "attack_tree": attack_tree, "visualization": viz_path}

            self.memory.end_session(session_id, result)
            self.complete(result)

            return {"status": "success", "agent": self.name, **result}

        except Exception as e:
            self.fail(str(e))
            return {"status": "error", "agent": self.name, "error": str(e)}

    def _map_vulnerabilities(self) -> Dict[str, List[str]]:
        return {
            "python": ["NFKC normalization", "Unicode identifiers"],
            "javascript": ["Unicode escapes", "UTF-16 encoding"],
            "java": ["Unicode escape preprocessing"],
            "go": ["UTF-8 validation edge cases"]
        }

    def _generate_attack_tree(self, vuln_map: Dict) -> Dict[str, Any]:
        return {"root": "Unicode Attacks", "children": [{"name": lang, "vulns": vulns} for lang, vulns in vuln_map.items()]}

    def _create_visualization(self, tree: Dict) -> str:
        viz_md = "# Attack Surface Map\n\n"
        for child in tree.get("children", []):
            viz_md += f"## {child['name']}\n"
            for vuln in child.get("vulns", []):
                viz_md += f"- {vuln}\n"

        viz_path = self.save_artifact("attack_surface_map", viz_md, "text")
        return viz_path


if __name__ == "__main__":
    agent = VulnerabilityCartographer({"model": "claude-sonnet-4-5-20250929"})
    result = agent.run("Map attack surfaces")
    print(f"Mapped: {result['status']}")
